<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
        <link rel="stylesheet"
          href="/a11y-dark.css">
    <script src="/highlight.pack.js"></script>
    <script>hljs.initHighlightingOnLoad();</script>
</head>
<body>


<pre><code># coding:utf-8<br>import mimetypes<br><br>import flask<br>from bson import ObjectId<br>from flask import Flask, render_template, request, redirect, url_for<br>from werkzeug.utils import secure_filename<br>import os<br>from pymongoUtils import GFS<br><br>app = Flask(__name__)<br><br><br>@app.route('/', methods=['POST', 'GET'])<br>def inde():<br>    return redirect('/index')<br><br><br>@app.route('/index', methods=['POST', 'GET'])<br>def index():<br>    filename = "IMG_0087.PNG"<br>    print(filename)<br>    gfs = GFS('fileDB', 'fileTable')<br>    (file_db, fileTable) = gfs.createDB()  # 创建数据库与数据表<br><br>    # 打印出数据库中的文件<br>    print(gfs.listFile(file_db))<br><br>    if filename in gfs.listFile(file_db):<br>        print("数据库中存在该文件，将会被读取到硬盘")<br>        query = {'filename': filename}<br>        id = gfs.getID(file_db, query)<br>        print(id)<br>        (bdata, attri) = gfs.getFile(file_db, id)  # 查询并获取文件信息至内存<br>        gfs.write_2_disk(bdata, attri)  # 写入磁盘<br><br>        return render_template(<br>            'index.html',<br><br>        )<br>    else:<br>        return render_template(<br>            'index.html',<br><br>        )<br><br><br>@app.route('/upload', methods=['POST', 'GET'])<br>def upload():<br>    if request.method == 'POST':<br>        f = request.files['file']<br>        basepath = os.path.dirname(__file__)  # 当前文件所在路径<br>        upload_path = os.path.join(basepath, 'static/uploads',<br>                                   secure_filename(f.filename))  # 注意：没有的文件夹一定要先创建，不然会提示没有该路径<br>        f.save(upload_path)<br>        print(f.filename)<br>        print(f)<br>        print(basepath)<br>        print(upload_path)<br><br>        # 将文件插入数据库<br>        gfs = GFS('fileDB', 'fileTable')<br>        (file_db, fileTable) = gfs.createDB()  # 创建数据库与数据表<br>        filePath = upload_path  # 插入的文件<br>        filename = (filePath.split('/')[-1])  # 获取插入文件的文件名<br>        mime = mimetypes.guess_type(filename)[0]  # 获取上传文件的MIME类型<br>        query = {'filename': filename, 'mime': mime}<br>        id = gfs.insertFile(file_db, filePath, query)  # 插入文件<br>        if id == None:<br>            id = gfs.getID(file_db, query)<br>        print(id)<br>        print(gfs.listFile(file_db))<br>        print("上传成功")<br>        ################<br><br>        ##将文件插入数据库之后就删除本地硬盘的文件<br>        os.remove(upload_path)<br>        print("插入数据库成功，删除上传文件")<br><br>        fid = id<br>        return flask.redirect('/upload/' + str(fid))<br><br>    else:<br>        return render_template('upload.html')<br><br><br>@app.route('/upload/&lt;fid&gt;', methods=['POST', 'GET'])<br>def uploadSuccess(fid):<br>    try:<br>        gfs = GFS('fileDB', 'fileTable')<br>        (file_db, fileTable) = gfs.createDB()  # 创建数据库与数据表<br>        (bdata, attri) = gfs.getFile(file_db, ObjectId(fid))  # 查询并获取文件信息至内存<br><br>        print(attri)<br><br>        print(attri.get('mime'))<br><br>        return flask.Response(bdata, mimetype=attri.get('mime'))<br>    except IOError:<br>        print("dd")<br><br>        # return render_template('uploadSuccess.html')<br><br><br>@app.route('/download', methods=['POST', 'GET'])<br>def download():<br>    if request.method == 'POST':<br>        filename = request.form['filename']<br>        print(filename)<br>        gfs = GFS('fileDB', 'fileTable')<br>        (file_db, fileTable) = gfs.createDB()  # 创建数据库与数据表<br><br>        # 打印出数据库中的文件<br>        print(gfs.listFile(file_db))<br><br>        if filename in gfs.listFile(file_db):<br>            print("数据库中存在该文件，将会被读取到硬盘")<br>            query = {'filename': filename}<br>            id = gfs.getID(file_db, query)<br>            print(id)<br>            (bdata, attri) = gfs.getFile(file_db, id)  # 查询并获取文件信息至内存<br>            gfs.write_2_disk(bdata, attri)  # 写入磁盘<br><br>        else:<br>            print("数据库中不存在该文件，请上传")<br>    return render_template('download.html')<br><br><br>@app.route("/download/&lt;filepath&gt;", methods=['GET'])<br>def download_file(filepath):<br>    # 此处的filepath是文件的路径，但是文件必须存储在static文件夹下， 比如images\test.jpg<br>    return app.send_static_file(filepath)<br><br><br>@app.route("/post", methods=['GET'])<br>def download_file1():<br>    return render_template('post.html')<br><br><br>@app.route("/admin", methods=['GET'])<br>def admin():<br>    return render_template('admin/login.html')<br><br><br>@app.route("/admin/index", methods=['GET'])<br>def admin1():<br>    return render_template('admin/index.html')<br><br><br>@app.route("/HIbernate和Mybatis优缺点对比", methods=["GET"])<br>def admin11():<br>    filename = "IMG_0087.PNG"<br>    print(filename)<br>    gfs = GFS('fileDB', 'fileTable')<br>    (file_db, fileTable) = gfs.createDB()  # 创建数据库与数据表<br><br>    # 打印出数据库中的文件<br>    print(gfs.listFile(file_db))<br><br>    if filename in gfs.listFile(file_db):<br>        print("数据库中存在该文件，将会被读取到硬盘")<br>        query = {'filename': filename}<br>        id = gfs.getID(file_db, query)<br>        print(id)<br>        (bdata, attri) = gfs.getFile(file_db, id)  # 查询并获取文件信息至内存<br>        gfs.write_2_disk(bdata, attri)  # 写入磁盘<br><br>        return render_template(<br>            'HIbernate和Mybatis优缺点对比.html',<br>            title="download/" + filename<br>        )<br>    else:<br>        return render_template(<br>            'HIbernate和Mybatis优缺点对比.html',<br>            title="download/" + filename<br>        )<br><br><br>@app.route("/help/404/1", methods=['GET', 'POST'])<br>def hel():<br>    return """<br>    <br>    fds &lt;img src="/upload/5c161ad3376cba361b1ef7d4" style="max-width:30%;"&gt;<br>    <br>    """<br><br><br>if __name__ == "__main__":<br>    app.run(host="0.0.0.0", port=8090, debug=True)</code></pre>

</body>
</html>